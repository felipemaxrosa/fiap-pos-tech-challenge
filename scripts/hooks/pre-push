#!/bin/sh

# Configura para usar o repositorio mockado
setNodeEnvToMock() {
    NODE_ENV_CURRENT=${NODE_ENV}
    export NODE_ENV='local-mock-repository'
}
# Restaura os valores originais
restoreNodeEnv() {
  export NODE_ENV=${NODE_ENV_CURRENT}
  unset NODE_ENV_CURRENT
}

# FunÃ§Ã£o para centralizar a mensagem e exibir em uma caixa
displayBoxedMessage() {
  message=$1
  total_width=80  # Largura total da caixa
  padding=3       # EspaÃ§o de preenchimento entre a mensagem e as bordas

  # Ajusta a mensagem para ter o mesmo comprimento total
  message=$(printf "%-${total_width}s" "$message")

  # Gera a linha superior da caixa
  echo "â•”$(printf 'â•%.0s' $(seq 1 $((total_width - 3))))â•—"

  # Gera a linha com a mensagem centralizada
  echo "â•‘$(printf "%-${total_width}s" "$message")â•‘"

  # Gera a linha inferior da caixa
  echo "â•š$(printf 'â•%.0s' $(seq 1 $((total_width - 3))))â•"
}

# Termina o programa, retornando a mensagem e status
exitWithMessage() {
  message=$1
  status=$2
  displayBoxedMessage "$message"
  restoreNodeEnv
  exit $status
}

setNodeEnvToMock

echo " ğŸš€ Executando testes de de integraÃ§Ã£o (modo local mocked).."
npm run test:e2e

e2etestStatus=$?

echo " ğŸš€ Verificando implementaÃ§Ãµes dos testes.."
npm run test:check -- --silent

# Verifica se os testes unitÃ¡rio falharam
if [ $e2etestStatus -ne 0 ]; then
  exitWithMessage " ğŸš¨ Testes de integraÃ§Ã£o falharam. Abortando o push." 1
fi

exitWithMessage " âœ… ValidaÃ§Ã£o pre-push finalizada com sucesso" 0